stages:
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  SERVER_DIR: "server"
  FRONTEND_DIR: "."

# Build du frontend
build_frontend:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    paths:
      - node_modules/
      - ${SERVER_DIR}/node_modules/
  script:
    - echo "üî® Building frontend..."
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - master

# Build et pr√©paration du backend
build_backend:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    paths:
      - ${SERVER_DIR}/node_modules/
  script:
    - echo "üî® Preparing backend..."
    - cd ${SERVER_DIR}
    - npm ci
    - npm run db:generate
  artifacts:
    paths:
      - ${SERVER_DIR}/
    expire_in: 1 hour
  only:
    - main
    - master

# D√©ploiement sur O2Switch
deploy_o2switch:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $O2SWITCH_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "üöÄ Deploying to O2Switch..."
    
    # Cr√©er la structure de dossiers si n√©cessaire
    - |
      ssh $O2SWITCH_USER@$O2SWITCH_HOST << 'ENDSSH'
      mkdir -p $O2SWITCH_DEPLOY_PATH
      mkdir -p $O2SWITCH_DEPLOY_PATH/server
      mkdir -p $O2SWITCH_DEPLOY_PATH/server/public/uploads
      mkdir -p $O2SWITCH_DEPLOY_PATH/dist
      ENDSSH
    
    # Synchroniser le frontend build
    - echo "üì¶ Syncing frontend..."
    - rsync -avz --delete dist/ $O2SWITCH_USER@$O2SWITCH_HOST:$O2SWITCH_DEPLOY_PATH/dist/
    
    # Synchroniser le backend
    - echo "üì¶ Syncing backend..."
    - rsync -avz --exclude 'node_modules' --exclude '.env' --exclude '.env.production' ${SERVER_DIR}/ $O2SWITCH_USER@$O2SWITCH_HOST:$O2SWITCH_DEPLOY_PATH/server/
    
    # Synchroniser les fichiers de configuration n√©cessaires
    - rsync -avz package.json package-lock.json ecosystem.config.js $O2SWITCH_USER@$O2SWITCH_HOST:$O2SWITCH_DEPLOY_PATH/
    
    # Installation des d√©pendances et d√©marrage sur le serveur
    - |
      ssh $O2SWITCH_USER@$O2SWITCH_HOST << 'ENDSSH'
      cd $O2SWITCH_DEPLOY_PATH
      
      # Installer les d√©pendances backend
      echo "üì• Installing backend dependencies..."
      cd server
      npm ci --production
      
      # G√©n√©rer le client Prisma
      echo "üîß Generating Prisma client..."
      npm run db:generate
      
      # Appliquer les migrations (utiliser migrate deploy en production)
      echo "üóÑÔ∏è Running database migrations..."
      npm run db:migrate:deploy || echo "‚ö†Ô∏è Migration failed, check manually"
      
      # Red√©marrer l'application (si vous utilisez PM2)
      echo "üîÑ Restarting application..."
      if command -v pm2 &> /dev/null; then
        pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
      else
        echo "‚ö†Ô∏è PM2 not found, please restart manually"
      fi
      
      ENDSSH
    
    - echo "‚úÖ Deployment completed successfully!"
  environment:
    name: production
    url: $O2SWITCH_URL
  only:
    - main
    - master
  when: manual
